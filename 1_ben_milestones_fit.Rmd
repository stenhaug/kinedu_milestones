---
title: "1_ben_milestones_3pl_vs_4pl"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
theme_set(theme_classic(base_size = 14))
library(mirt)
```

# Prepare data

```{r}
# read in
fix_names <- function(x) ifelse(x == "", paste0("X__", 1:length(x) - 1), x)

d_raw <- 
  readxl::read_xlsx(
    "data/norming2/Kinedu Norming Survey Raw Data - May 15 2018.xlsx", 
    .name_repair = fix_names
  )

# prepare irt matrix
d <- 
  d_raw %>%
  mutate(age = as.numeric(X__422), 
         gestation = as.numeric(X__3),
         kinder = as.numeric(X__4),
         diagnosis = as.numeric(X__1), 
         id = `Nombre variable`) %>%
  slice(4:n()) %>% # drop two top label rows. 
  select(-starts_with("X"), -`Nombre variable`) %>%
  gather(code, response, abs_183:color_679) %>%
  mutate(code = str_replace(code, "^d_","d"),
         code = str_replace(code, "^e_",""),
         code2 = code) %>%
  separate(code2, into = c("category","number")) %>%
  select(-number) %>%
  mutate(response = as.numeric(response)) %>% 
  filter(age != 0) # DROP AGE 0

d_wide <- d %>%
  select(id, code, response) %>%
  spread(code, response)
  
d_mat <- d_wide %>%
  select(-id) %>% 
  data.frame %>%
  data.matrix

colnames(d_mat) <- sort(unique(d$code))
rownames(d_mat) <- d_wide$id

# lots of items / students is relatively high
dim(d_mat)
```

# Should we use the 3PL or the 4PL?

## Estimate models

Fit models

```{r}
mod_3pl <- mirt(d_mat, 1, itemtype='3PL', verbose=TRUE, TOL = 0.0001)
mod_4pl <- mirt(d_mat, 1, itemtype='4PL', verbose=TRUE, TOL = 0.00000001)
```

Bizarre that the more flexible 4pl has a less probable likelihood

```{r}
mod_3pl@Fit$logLik
mod_4pl@Fit$logLik
```

## Ability

Abilities correlate highly between the two models with the expected ceiling on ability imposed by the 4pl model.

```{r}
fscores_3pl <-
    tibble(
        id = rownames(d_mat), 
        ability = fscores(mod_3pl, method = "EAP")[ , 1]
    )

fscores_4pl <- 
    tibble(
        id = rownames(d_mat), 
        ability = fscores(mod_4pl, method = "EAP")[ , 1]
    )

plot(fscores_3pl$ability, fscores_4pl$ability)
```

## Items

Clean up coefficients

```{r}
coef_3pl <- 
    coef(mod_3pl, simplify = TRUE)$items %>% 
    as.data.frame() %>% 
    mutate(item = row.names(.)) %>% 
    as_tibble()

coef_4pl <- 
    coef(mod_4pl, simplify = TRUE)$items %>% 
    as.data.frame() %>% 
    mutate(item = row.names(.)) %>% 
    as_tibble()
```

Find items with low upper bounds. These will be the items the 3PL and 4PL disagree most on.

```{r}
coef_4pl_low_u <- 
    coef_4pl %>% 
    arrange(u) %>% 
    filter(u < 0.5) %>% 
    print()

coef_3pl %>% filter(item %in% coef_4pl_low_u$item)
```

So, which model is right?

## Manually look at item fit

Select an item to work with

```{r}
# this is "Draw a person with at least two body parts"
item <- "color_666"
```

Look at performance on that item by bucket

```{r}
midcut <- function(x, from, to, by){
   x <- cut(x,seq(from,to,by),include.lowest=T)
   vec <- seq(from+by/2,to-by/2,by)
   names(vec) <- levels(x)
   unname(vec[x])
}

ability_and_item <- 
    tibble(
        theta_3pl = fscores_3pl$ability,
        theta_4pl = fscores_4pl$ability,
        correct = d_mat[ , item]
    ) %>% 
    mutate(
        theta_3pl_bucket = midcut(theta_3pl, -6, 5, 0.25),
        theta_4pl_bucket = midcut(theta_4pl, -6, 5, 0.25)
    )

buckets_3pl <- 
    ability_and_item %>% 
    group_by(theta_3pl_bucket) %>% 
    summarize(
        p_correct = mean(correct),
        n = n()
    )

buckets_4pl <- 
    ability_and_item %>% 
    group_by(theta_4pl_bucket) %>% 
    summarize(
        p_correct = mean(correct),
        n = n()
    )
```

Pick an item and compare the item response curves

```{r}
crossing(
    model = c("mod_3pl", "mod_4pl"),
    theta = seq(-6, 5, length.out = 1000)
) %>% 
    # plot probability from the models
    mutate(
        prob = 
            map2_dbl(
                model, 
                theta, 
                ~ probtrace(
                    extract.item(
                        get(.x), 
                        which(coef_3pl$item == item)
                    ), 
                    .y
                )[2]
            )
    ) %>% 
    ggplot(aes(x = theta, y = prob, color = model)) +
    geom_point(alpha = 1) +
    # empirical 3pl
    geom_point(
        data = buckets_3pl,
        aes(
            x = theta_3pl_bucket,
            y = p_correct
        ),
        color = "darkred"
    ) +
    # empirical 4pl
    geom_point(
        data = buckets_4pl,
        aes(
            x = theta_4pl_bucket,
            y = p_correct
        ),
        color = "cyan"
    ) +
    labs(title = paste0("item fit for ", item)) +
    scale_y_continuous(labels = scales::percent)
```

